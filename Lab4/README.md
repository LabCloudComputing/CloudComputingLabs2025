# 实验文档

## 1. 系统概述

在 Lab 2 中，我们完成了一个简化的 HTTP/1.1 Web 服务器；

在 Lab 3 中，我们完成了一个简化的 分布式数据库系统。

现在让我们尝试将两者组合并完善，开发一个基于Web的聊天系统，能够连接并管理多个大型语言模型(LLM)后端，提供统一的用户聊天界面。系统应支持负载均衡和故障转移，确保服务的高可用性和稳定性。

**任务点：补充代码**

```
文件目录：Lab4\modules\backend_manager.py

def get_available_backend():
    """
    选择一个可用后端（可用于负载均衡）
    
    返回:
        dict: 选择的后端信息，包含backend_id字段
    """
    #lab4_Job:请补充代码，实现自己的算法选择一个后端返回
    
    
```

## 2. 背景知识

你所需要的有关 Http Server 与 Distributed Database 的基础知识都在过去的实验中，如果你忘记了或者想要复习，可以重新查看 [Lab 2](https://github.com/1989chenguo/CloudComputingLabs/tree/master/Lab2) 和 [Lab 3](https://github.com/1989chenguo/CloudComputingLabs/tree/master/Lab3)。

### Dividing databases

随着近些年信息化大发展，越来越多的数据存入了数据库中，而物理服务器的CPU、内存、存储、连接数等资源是有限的，某个时段大量连接同时执行操作，会导致数据库在处理上遇到性能瓶颈。为了解决这个问题，行业先驱门充分发扬了`分而治之`的思想，对大表进行分割，然后实施更好的控制和管理，同时使用多台机器的CPU、内存、存储，提供更好的性能。

其中一种简单的逻辑分割是`垂直分库`。比如我们的数据库中有商品表Products、还有对订单表Orders，还有积分表Scores。接下来我们就可以创建三个数据库，一个数据库存放商品，一个数据库存放订单，一个数据库存放积分。如下图所示：

![img](https://gitee.com/hnu-cloudcomputing/CloudComputingLabs/raw/master/Lab4/static/img1.png)

这样做有以下几个优点：

- 跟随业务进行分割，和最近流行的微服务概念相似，方便解耦之后的管理及扩展。
- 高并发的场景下，垂直拆分使用多台服务器的CPU、I/O、内存能提升性能，同时对单机数据库连接数、一些资源限制也得到了提升。
- 能实现冷热数据的分离。

当然，分库分表在实际应用中是一个十分复杂的设计，在低并发的应用程序中，分库分表的效果并不明显，因此需要根据业务需求，并发承载能力等综合考虑。为了简化这一过程，在实验中，我们仅要求对数据进行垂直分库，即将课程数据和学生信息分别存储到不同的节点中，以此来实现课程数据访问和学生信息访问互不影响的效果。

### Load Balancing

负载平衡（英语：load balancing）是一种电子计算机技术，用来在多个计算机（计算机集群）、网络连接、CPU、磁盘驱动器或其他资源中分配负载，以达到优化资源使用、最大化吞吐率、最小化响应时间、同时避免过载的目的。 使用带有负载平衡的多个服务器组件，取代单一的组件，可以通过冗余提高可靠性。负载平衡服务通常是由专用软件和硬件来完成。 主要作用是将大量作业合理地分摊到多个操作单元上进行执行，用于解决互联网架构中的高并发和高可用的问题。

负载均衡最重要的一个应用是利用多台服务器提供单一服务，对于互联网服务，负载平衡器通常是一个软件程序，这个程序侦听一个外部端口，互联网用户可以通过这个端口来访问服务，而作为负载平衡器的软件会将用户的请求转发给后台内网服务器，内网服务器将请求的响应返回给负载平衡器，负载平衡器再将响应发送到用户，这样就向互联网用户隐藏了内网结构，阻止了用户直接访问后台（内网）服务器，使得服务器更加安全，可以阻止对核心网络栈和运行在其它端口服务的攻击。

当所有后台服务器出现故障时，有些负载平衡器会提供一些特殊的功能来处理这种情况。例如转发请求到一个备用的负载平衡器、显示一条关于服务中断的消息等。负载平衡器使得IT团队可以显著提高容错能力。它可以自动提供大量的容量以处理任何应用程序流量的增加或减少。

为了更好的实现负载均衡器，你可能需要选择一种或几种合适的调度算法。

## 3. 核心功能需求

### 3.1 多后端管理

- 支持添加、删除和管理多个LLM后端服务（如OpenAI等）
- 提供Web界面进行后端服务的配置管理

### 3.2 聊天功能

- 支持文本输入和回复显示
- 保持对话上下文，确保多轮对话的连贯性
- 支持长对话历史的智能截断，避免超出模型上下文限制

### 3.3 负载均衡与高可用

- 实现多后端间的请求分发机制
- 支持后端故障转移，当一个后端失败时自动使用其他后端

## 4. 技术要求

- 前端：基于HTML/CSS/JavaScript的响应式Web界面
- 后端：可使用成熟框架开发Web服务
- 通信：需要支持OpenAI兼容的API格式
- 存储：使用实验三开发的分布式键值存储系统保存后端信息和聊天历史

## 5. 性能要求

- 支持多用户并发

## 6.提交要求

1. 补全指定位置代码
2. 在Lab4文件夹（而不是Lab4的子文件夹下！）下必须有一个文件名为“小组名称+Lab4报告“的文件，此文件内需有要求的两个截图：①截取成语接龙的对话页面，②后端管理（需要至少配置有一个后端）的界面。  
   实验报告放相应截图就可以（必要），也可以把自己的一些实现的思考过程以及有价值的点写上去（非必要）。

## 7.评分标准

- 完成所有要求，你将获得 10 分。
- 如果你有部分功能没有实现，将根据你的完成情况进行细化打分。

